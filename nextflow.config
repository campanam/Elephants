// Forked from Kauai pipeline (version 2) on 20 Jan 2023

manifest {

	name = 'Elephant Genomics'
	author = 'Michael G. Campana'
	homePage = 'https://github.com/campanam/Elephants'
	description = 'Pipeline to analyze elephant genomics'
	mainScript = 'elephants.nf'
	version = '0.1.0'
	nextflowVersion = '>=20.10.0'

}

params {

	outdir = "$baseDir/kauai_results_v2" // Output directory
	refseq = "$baseDir/hofi_genome_genbank_v2_masked.fa" // House finch genome reference sequence
	mtDNA = "$baseDir/hofi_mt.fasta" // Mitochondrial reference sequence file
	samples = "$baseDir/kauai_libraries_v2.csv" // CSV detailing sequencing libraries and needed analyses
	reads = "$baseDir/RawData/" // Path to reads
	min_uniq_mapped = 10 // Minimum number of unique mapped reads to retain an alignment file
	java_options = "" // Execution options for java jar files (Java 1.8)
	
}

profiles {
	hydra {
	
		params.java_options = '-D64 -Dserver -XX:MaxHeapSize=14G' // Options for Java 1.8
	
		executor {
	
			name = 'sge'
			exitReadTimeout = '10min'
	
		}
	
		process {
			maxForks = 1000 // Prevent job submission overflow
			storeDir = 'chkpnt' // Prevent remaking completed files
			errorStrategy = 'finish'
			maxRetries = 1
			
			withName: buildRef { 
				clusterOptions = '-l mres=16G,h_data=16G,h_vmem=16G,himem -S /bin/bash'
				queue = 'mThM.q'
			}
			withName: buildMitoRef {
				clusterOptions = '-l mres=1G,h_data=1G,h_vmem=1G -S /bin/bash'
				queue = 'sThC.q'
			}
			withName: 'alignMitoSeqs|alignSeqs' { 
				queue = 'mThM.q'
				penv = 'mthread'
				cpus = 16
				clusterOptions = "-l mres=8G,h_data=8G,h_vmem=8G,himem -S /bin/bash"
			}
			withName: 'buildRef|buildMitoRef|alignMitoSeqs|alignSeqs|flagStats|mergedFlagStats' {
				conda = 'bioconda::bwa=0.7.17 bioconda::samtools=1.16.1 conda-forge::libzlib=1.2.13'
			}
			withName: trimAdapters { 
				queue = 'mThC.q'
				conda = 'bioconda::adapterremoval=2.3.3 conda-forge::libzlib=1.2.13'
				clusterOptions = '-l mres=8G,h_data=8G,h_vmem=8G -S /bin/bash'
			}
			withName: 'leftAlignIndels|markDup|mergedLeftAlignIndels|mergedMarkDup' {
				cpus = 2
				penv = 'mthread'
				clusterOptions = '-l mres=16G,h_data=16G,h_vmem=16G,himem -S /bin/bash'
				queue = 'mThM.q'
				conda = 'bioconda::picard=2.27.4 bioconda::gatk4=4.3.0.0'
			}
			withName: 'flagStats|mergedFlagStats' { 
				clusterOptions = "-l mres=2G,h_data=2G,h_vmem=2G,himem -pe mthread 8 -S /bin/bash"
				queue = 'sThC.q'
			}
		}
	}
}
